---
title: "ACCESS-OM2 & Bash Tips and Tricks"
author: "Maurice F. Huguenin, m.huguenin-virchaux@unsw.edu.au"
date: "Last compiled on `r format(Sys.time(), '%d %B %Y, %X %Z')`"
output:
  html_document:
    keep_md: false # true would create a .md file in the folder
    toc: true
    toc_float: true
    number_sections: true
      
#output: html_document
#output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


-------------------------------------------------------------------------------
<img src="PhD Motivation/2010-station-no-dome-s.jpg" style="width:100%; border:0px solid; margin-right: 20px" align="center">
<div style="text-align: right">Amundsen-Scott South Pole Station, Antarctica, Photo by Dana Hrubes</div>
<div style="text-align: right">"Difficulties are just things to overcome, after all." - Ernest Shackleton</div>

# Branching off an IAF perturbation simulation from the ACCESS-OM2-1 model

1. `mkdir 1deg_jra55_iaf_Atlantic` and `cd` into it
2. git clone the branch from where I would like to complete simulation: `git clone -b Pacific git@github.com:mauricehuguenin/1deg_jra55_iaf.git ./`
3. `git branch` to check on which branch I am currently at
4. change input files accordingly
5. create a new branch using `git checkout -b Atlantic` and push that branch with `git push -u origin Atlantic`
6. check on github if I have a new branch and everything is done correctly
7. make an archive directory on scratch: `mkdir /scratch/e14/mv7494/access-om2/archive/1deg_jra55_iaf_Atlantic`
8. update the archive link with `ln -sfn /scratch/e14/mv7494/access-om2/archive/1deg_jra55_iaf_Atlantic archive`
9. change `jobname` in `config.yaml`
10. change `accessom2.nml` to 
```
    forcing_start_date = '1972-01-01T00:00:00'
    forcing_end_date = '2018-01-01T00:00:00'
```
11. copy over `output200` and `restart200` to the archive folder
12. make sure I have `cice_in.nml` in `output200/ice`
13. check/fix `FORCING_CUR_DATE` and `EXP_CUR_DATE` in `archive/restart200/accessom2.restart.nml` to
```
 &DO_NOT_EDIT_NML
 FORCING_CUR_DATE        = 1972-01-01T00:00:00,
 EXP_CUR_DATE    = 1972-01-01T00:00:00
 /

```
14. `archive/restart500/ocean/ocean_solo_res` needs to look like this:
```
     3        (Calendar: no_calendar=0, thirty_day_months=1, julian=2, gregorian=3, noleap=4)
  1972     1     1     0     0     0        Model start time:   year, month, day, hour, minute, second
  1972     1     1     0     0     0        Current model time: year, month, day, hour, minute, second
```
15. for the first submit, use `use_restart_time=.false.` in `ice/cice.nml`
16. make sure I have the correct executable for mom:
```
    - name: ocean
      model: mom
      exe: /g/data/e14/rmh561/access-om2/bin/fms_ACCESS-OM_fd3e1a3_libaccessom2_a9d4b67.x
      input: /g/data/ik11/inputs/access-om2/input_236a3011/mom_1deg
      ncpus: 216
```
17. make sure I have the correct `ocean/diag_table` and correct frequencies for the output
```
# output files
"ocean_month",      1,  "months", 1, "days", "time",
"ocean",            12,  "months", 1, "days", "time",
"ocean_grid",      -1,  "months", 1, "days", "time",
"ocean_scalar",     1,  "months", 1, "days", "time",
"ocean_snap",      12,  "months", 1, "days", "time",
"ocean_wmass",     12,  "months", 1, "days", "time",
"ocean_heat",      12,  "months", 1, "days", "time",
```

18. `payu setup` and `payu sweep` to establish the new manifest paths
19. to check in real-time if the model uses the correct input:
```
tail -f work/atmosphere/log/matmxx.pe00000.log
```
I saved this now as the alias `tailcheck` in the `~/.bashrc` file. This command must be run in the folder from where I use the payu commands.

20. after first submit, use `use_restart_time=.true.` in `ice/cice.nml`


&#8594; link to Andrew's wiki: [https://github.com/COSIMA/access-om2/wiki/Tutorials#starting-a-new-experiment-using-restarts-from-a-previous-experiment](https://github.com/COSIMA/access-om2/wiki/Tutorials#starting-a-new-experiment-using-restarts-from-a-previous-experiment)

# Turning on WMT diagnostics in the CTRL simulation
1. replace MOM executable with the following: `exe: /g/data/e14/rmh561/access-om2/bin/fms_ACCESS-OM_da70c54_libaccessom2_4198e15.x`
2. use the `diag_table` from `/home/561/rmh561/access-om2/1deg_jra55_iaf/ocean/diag_table_Maurice` which I renamed `diag_table_WMT`
3. update the `&ocean_density_nml` namelist in `ocean/input.nml` to:
```
&ocean_density_nml
    neutral_density_theta = .true.
    neutral_density_potrho = .false.
    nrho_face_bin = .true.
    eos_linear = .false.
    eos_preteos10 = .true.
    layer_nk = 74
    neutralrho_min = -3.0
    neutralrho_max = 34.0
    potrho_max = 1038.0
    potrho_min = 1028.0
/
```
4. for the first commit, use `use_restart_time=.false.` in `ice/cice.nml`

# How to branch off a perturbation simulation and configuring everything through .git
1. mkdir `1deg_jra55_iaf_Pacific`
2. set github connection with `git remote set-url origin git@github.com/mauricehuguenin/1deg_jra55_iaf`
3. have a look at what branches I have`git branch`
4. create a new branch called Pacific with `git checkout -b Pacific`
5. `git branch` and `git status` to check files
6. push to github with `git push origin -u Pacific`
7. enter password if necessary (the SSH connection set up on 2020-09-22 requires the ETH password with *15, i.e. a single 5 at the end)
8. `git branch`
9. `git clone git@github.com:mauricehuguenin/1deg_jra55_iaf.git ./` to download the config files from the github repo
10. `git checkout --track origin/Pacific` to track changes in the new `Pacific` branch
11. `git checkout -b Pacific`
12. after the changes are done and a new run is up I can then do `git push origin -u Pacific` again to push the changes up to github

<!-- # Set up a github connection from a folder on GADI -->
<!-- ATTENTION! THIS IS OLD AND NOT CORRECT -->
<!-- 1. clean any existing git connection: `rm -rf .git` -->
<!-- 2. `git init` -->
<!-- 3. `git add .` -->
<!-- 4. `git commit -m "first commit"` -->
<!-- 5. `git remote add origin git@github.com:mauricehuguenin/HeatDist_scripts.git` -->
<!-- 6. `git push --force origin master` -->

# Setting the ACCESS-OM2 time step
The timestep is normally set to a factor of the JRA55-do forcing period of 3hr = 10800s, for example one of 100, 108, 120, 135, 144, 150, 180, 200, 216, 225, 240, 270, 300, 360, 400, 432, 450, 540, 600, 675, 720, 900, 1080, 1200, 1350, 1800, 2160, 2700, 3600 or 5400s. The default timestep for this configuration is 1350 seconds, and the model is stable with this timestep right from the start. After the first year or two of model equilibration you may be able to run with a 1800s timestep for faster throughput.

# Check CPU usage of job running on Gadi
`nqstat_anu job_id`

# Calculate trend files of control simulation with CDO
`cdo trend -mergetime output20*/ocean/ocean.nc trend_mergetime_ocean.nc &`

# Calculating the linear trend in the ocean_wmass.nc file
- This file is too big to use `cdo detrend ifile ofile` as it cannot load all the timeseries into memory
```
# (I) merge files, select correct time period and variables
cdo.selvar(var, input = '-selyear,1972/2017 -mergetime ' + base+'output20*/ocean/ocean_wmass.nc',
          output = base2+'mergetime_output201-205_ocean_wmass.nc', force=False)
# (II) calculate trend files
cdo.trend(input = base2+'mergetime_output201-205_ocean_wmass.nc',
          output = base2+'afile.nc ' + base2+'bfile.nc', force=False)
# (IV) remove the trend from the merged files, subtract the detrended data and multiply by (-1) to
# get: trend = climatology - (climatology - trend) * (-1)
cdo.mulc('-1',input = '-sub -subtrend ' + base2+'mergetime_output201-205_ocean_wmass.nc ' + 
         base2+'afile.nc ' + base2+'bfile.nc ' + base2+'mergetime_output201-205_ocean_wmass.nc',
         output = base2+'trend_mergetime_output201-205_ocean_wmass.nc', force=False)
```

# Check remaining allocation on Gadi
`nci_account -P e14 -v`

# Copy data to or from Gadi
```
rsync -aruv <username>@gadi.nci.org.au:/path/on/gadi/filename.nc .
rsync -aruv <username>@gadi.nci.org.au:/path/on/gadi/filename.nc path/on/local/machine/filename.nc
```

# Download Argo OBS from the internet directly to the terminal
Roemmich and Gilson, 2009 data from Scripps: http://sio-argo.ucsd.edu/RG_Climatology.html
```
wget ftp://kakapo.ucsd.edu/pub/gilson/argo_climatology/RG_ArgoClim_Temperature_2019.nc.gz
zcat RG_ArgoClim_Temperature_2019.nc.gz > RG_ArgoClim_Temperature_2019.nc # to unzip the .nc.gz file

# or 
wget ftp://data.argo.org.cn/pub/ARGO/BOA_Argo/NetCDF/BOA_Argo_20{14..19}_{01..12}.nc

# or alternatively if it is a .zip file:
unzip \*.zip 
```
Roemmich et al. (2015) data from https://www.seanoe.org/data/00311/42182/#42254:
```
wget https://www.seanoe.org/data/00311/42182/data/42254.tar.gz
tar -zxvf 42254.tar.gz # to unpack
```

# Collating output after the simulation ends
- increase walltime of collate to `3:00:00` when WMT diagnostics are active as `ocean_wmass.nc` is quite a big file
- `module unload conda` followed by `module load conda` loads the default analysis3-20.01(analysis3:default) environment
- `payu collate -d archive/output051/ocean` then collates the `ocean_wmass.nc`` files
- it takes `Walltime Used: 01:06:11` for the 1deg_jra55_iaf configuration with WMT on
# List all files in subfolders
`find . -type f -printf "%f\n"`

# Show CPU usage and memory percent
`/g/data/hh5/public/apps/nci_scripts/uqstat`

# Rename variable and delete dimension in .nc file with CDO
change name from XT_OCEAN to xt_ocean and YT_OCEAN to yt_ocean respectively

`cdo chname,XT_OCEAN,xt_ocean,YT_OCEAN,yt_ocean ifilen.nc ofile.nc`

remove the dimension 'ST_OCEAN1_1'

`ncwa -a ST_OCEAN1_1 ifile.nc ofile.nc`

# Setting the Nino3.4 region to a certain value or selecting it
```
tos_nino34 = tos.isel(time=0).where((tos.lat>5) | (tos.lat<-5) | (tos.lon<190) | (tos.lon>240),273).plot()
tos_nino34 = tos.isel(time=0).where((tos.lat>5) | (tos.lat<-5) | (tos.lon>190) | (tos.lon>240), tos.isel)

# see also the __jra55_preparation_TROPICS_1972-2018_inverse_as_ryans_suggestion.ipynb__ script where I do it in an actual dataset
```

# Start jupyter notebook from Bash on Ubuntu on Windows

`cd /mnt/c/Users/Maurice\ Huguenin/nci_scripts-master/`

`./gadi_jupyter`

`python3 vdi_jupyter.py`

Use the following command as pointed out by @scott on the ARCCSS support slack channel on the 25th of November 2020:

`./gadi_jupyter -s scratch/w35+gdata/v45`

To change settings in the gadi_jupyter notebook use
```
- vi gadi_jupyter
- ESC -> a
- make edits
- ESC -> : -> wq -> ENTER (write-quit)
```
- Password for `vdi_jupyter` is ending with `...555`


# Make folder group-readable
`chmod -R g+rX ~/access-om2/1deg_jra55v131_iaf/`
```
drwxr-xr-x
d # a directory
rwx # me as the user can read, write & execute
r-x # the group can read & execute but not write
r-x # others, neither me or my group can read & write but not execute

```

# Display human-readable file sizes in the console
`ls -lh`

# Replace values in xarray dataset by another value
```
basin_mask = xr.open_mfdataset('/g/data/e14/mv7494/basin_mask_mom_1deg.nc').BASIN_MASK
basin_mask = basin_mask.where(basin_mask != 4,2) # replace Arctic Ocean index values (i.e. 4) with 
basin_mask.plot(cmap='tab20')                    # Atlantic Ocean index values (i.e. 2)
```
<img src="Important Figures/basin_mask_ACCESS-OM2-1.png" align="center">

# Revert ERA5 land-sea mask
Rewrite land-sea mask so that all ocean = 1 and all land = 0 instead of the other way around
```
lsm = xr.open_mfdataset('/g/data/e14/mv7494/ERA5_land_sea_mask_025deg.nc').lsm[0,:,:]
lsm = lsm.where(lsm == 0,2) # set all non-zero values (i.e.land) to index 2
lsm = lsm.where(lsm == 2,1) # set all non-land values (i.e. ocean) to index 1
lsm = lsm.where(lsm != 2,0) # set all land to index 0
lsm = lsm.where(lsm !=0) # replace all zeroes by nan
```
# Create an area_t file for a specific grid cell resolution
In this example the ERA5 grid is (**latitude**: 721, **longitude**: 1440), i.e. 1/4°
```
dyt_ERA = np.full(721, (6371e3*np.pi)/721)     # half the circumference of the Earth divided by number of lat grids
dxt_ERA = np.full(1440, (6371e3*2*np.pi)/1440) # circumference of the Earth divided by the number of lon grid cells

a = np.linspace(-np.pi/2, np.pi/2,721)
for l in range(721):
    dyt_ERA[l] = np.cos(a[l]) * dyt_ERA[l] # scale with cosine of latitude
  
aa, bb = np.meshgrid(dxt_ERA,dyt_ERA) # create meshgrid
os.system('rm -r /g/data/e14/mv7494/ERA5/ERA5_grid.nc')
(lsm*aa*bb).to_dataset(name='area_t').to_netcdf('/g/data/e14/mv7494/ERA5/ERA5_grid.nc') # ERA5 area
area_t_ERA = (lsm*aa*bb)
```
<img src="Important Figures/ERA5_grid_area_t.png" align="center">



- . - . - . - THIS ONE NOT CORRECT YET, DYT AND DXT VERTAUSCHT


# Download File from Gadi to local machine/local desktop
```
rsync -aruv mv7494@gadi.nci.org.au:/home/561/mv7494/HeatDist_figures/ACCESS-OM2-1_control_overturning_streamfunction.png /mnt/c/Users/Maurice\ Huguenin/Desktop/
```

# Redi diffusion
- Redi diffusion parameterizes eddy transport of heat along isopycnals and is significant only in the Southern Ocean.
- $\kappa$ = diapycnal mixing coefficient, ~0.3e-4 m$^2$ s$^{-1}$ in the upper 2000 m

# What to do when I get: atm and ice models are out of sync
```
Error in accessom2_deinit: atm and ice models are out of sync.
atm end date: 2022-01-01T00:00:00.000
ice end date: 1966-01-01T00:00:00.000
```

# How to create a public SSH key and add it to github
- ` ssh-keygen -t rsa -b 4096 -C m.huguenin-virchaux@unsw.edu.au`
- ENTER = save in default directory
- enter passphrase, here for connection to gadi I use standard ETH password with *15, i.e. a single 5 at the end
- download file in `/home/561/mv7494/.ssh/id_rsa.pub` to local Windows 10 machine and open file with notepad
- copy the content to clipboard
- on github: go to Settings -> SSH and GPG keys
- add new SSH key with title `SSH Key GADI`
Github is now configured for gadi where I created the key

# How to plot boundary lines between the ocean basins using cartopy
```
# lon, lon, lat, lat
plt.plot([146, 146], [-34,  -90],color='b', transform=ccrs.PlateCarree()) # Tasmania - Antarctica
plt.plot([-71, -71], [-34,  -90],color='b', transform=ccrs.PlateCarree()) # Feuerland - Antarctica
plt.plot([180,200], [66,  66],color='b', transform=ccrs.PlateCarree()) # Beringstrasse
plt.plot([142,142], [-4,  -20],color='b', transform=ccrs.PlateCarree()) # Arnhemland - Papua Neu Guinea
plt.plot([115,142], [-8,  -8],color='b', transform=ccrs.PlateCarree()) # Guinea - Java
plt.plot([102,102], [0,  5],color='b', transform=ccrs.PlateCarree()) # Strasse von Malakka
```
<img src="Important Figures/ocean_boundaries.png" align="center">

# How to adapt the ./gadi_jupyter.py script in vim
- edit: `ESC -> a -> insert change`
- write, save and close script: `ESC -> :wq`

# How to open Julia programming language
`START` -> `Anaconda Navigator (Anaconda3)` -> open `jupyterlab` (should open new tab in firefox) -> click `Julia 1.5.2`

# How to delete branch locally and remotely with git
```
// delete branch locally
git branch -d localBranchName

// delete branch remotely
git push origin --delete remoteBranchName

```

# How to locate ERA5 data on Gadi
For example here the 2 meter surface air temperature values:
```
t2m = xr.open_dataset('/g/data/ub4/era5/netcdf/land/t2m/2019/t2m_era5land_global_20191201_20191231.nc').t2m
t2m = t2m.sel(time='2019-12-19').mean('time') - 273.15
t2m.plot()
plt.savefig(save + 'era5_t2m_20191219', dpi=300, facecolor='w',
            edgecolor='w', orientation='landscape', papertype=None, 
            format=None, transparent=False, bbox_inches='tight', 
            pad_inches=0.1, metadata=None)
# Wall time: 7.48 s
```
<img src="Important Figures/era5_t2m_20191219.png" align="center" width="300px">

# How to create the linear trend in a netcdf file (for example in JRA55-do's SAT files)
```
cdo -detrend -selyear,1972/2018 -yearmean -mergetime ifile.nc ofile.nc
cdo yseassub ifile.nc -yseasavg ifile.nc ofile.nc
cdo trend ifile.nc intercept.nc trend.nc
```

# Citations in the AGU LaTeX template
`\cite{kiss2019access}` -> (Kiss et al., 2019)

`\citeA{kiss2019access}` -> Kiss et al. (2019)

`\cite<KPP,>{large1994oceanic}` -> (KPP, Large et al., 1994)

# Rotblau Colorbar in Python
<img src="Important Figures/colorbar.png" align="center" width="300px">
```
rotblau = [[0.4 , 0.  , 0.12], [0.47, 0.02, 0.13], [0.62, 0.07, 0.16], [0.66, 0.16, 0.2],
           [0.8 , 0.3 , 0.27], [0.87, 0.44, 0.35], [0.93, 0.58, 0.45], [0.96, 0.7 , 0.58], 
           [0.98, 0.8 , 0.71], [0.98, 0.94, 0.92], [0.93, 0.95, 0.96], [0.85, 0.91, 0.95],
           [0.76, 0.87, 0.93], [0.64, 0.8 , 0.89], [0.49, 0.72, 0.84], [0.34, 0.62, 0.79], 
           [0.23, 0.53, 0.74], [0.16, 0.44, 0.7] , [0.1 ,0.35, 0.6], [0.05, 0.24, 0.45], 
           [0.02, 0.19, 0.38]]
```

# Scientific Notation in R
`print(3.5e23/6.3e13, dig=3)` gives the result with exponent
The values here represent the total ocean heat uptake 1971-2018 (J) divided by the energy of one Hiroshima atom bomb (J).

# Calculating moving average in python
```
import bottleneck as bn

OHC_access = bn.move_mean(OHC_access, window=5, min_count=1)
plt.plot(OHC_access)
```

# Downloading NOAA ERSSTv5 (Huang et al., 2017)
```
wget https://www.ncei.noaa.gov/pub/data/cmb/ersst/v5/netcdf/ersst.v5.19{58..72}{01..12}.nc
```




